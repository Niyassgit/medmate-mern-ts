generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model Department {
  id        String       @id @default(auto()) @map("_id") @db.ObjectId
  name      String
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  isActive  Boolean      @default(true)
  doctors   Doctor[]
  reps      MedicalRep[]
}

model otpVerification {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  otp       String
  purpose   String
  expiredAt DateTime
  createdAt DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiredAt], map: "otp_expiry_idx")
}

model User {
  id           String       @id @default(auto()) @map("_id") @db.ObjectId
  email        String       @unique
  password     String?
  role         Role
  profileImage String?
  tokenVersion Int          @default(0)
  authProvider AuthProvider @default(NATIVE)
  isBlocked    Boolean      @default(false)
  providerId   String?
  isVerified   Boolean      @default(false)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  senderNotifications   Notification[] @relation("SentNotifications")
  receiverNotifications Notification[] @relation("ReceivedNotifications")

  superAdmin       SuperAdmin?
  doctor           Doctor?
  medicalRep       MedicalRep?
  otpVerifications otpVerification[]
}

enum Role {
  SUPER_ADMIN
  DOCTOR
  MEDICAL_REP
}

enum AuthProvider {
  NATIVE
  GOOGLE
}

model Doctor {
  id              String    @id @default(auto()) @map("_id") @db.ObjectId
  name            String
  phone           String
  departmentId    String?   @db.ObjectId
  experienceYears Int?
  hasOwnClinic    Boolean?
  doctorClass     String?
  territoryId     String?   @db.ObjectId
  hospital        String
  licenseImageUrl String?
  opStartTime     String?
  opEndTime       String?
  opSession       String?
  dob             DateTime?
  registrationId  String
  about           String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  department           Department?        @relation(fields: [departmentId], references: [id])
  territory            Territory?         @relation(fields: [territoryId], references: [id])
  interests            Interest[]
  connections          Connection[]
  doctorConn1          DoctorConnection[] @relation("Doctor1")
  doctorConn2          DoctorConnection[] @relation("Doctor2")
  referralsGiven       DoctorReferral[]   @relation("ReferringDoctor")
  referralsReceived    DoctorReferral[]   @relation("ReferredDoctor")
  conversations        Conversation[]
  repReferralsReceived RepReferral[]      @relation("ReferredDoctorInRepReferral")
  educations           Education[]
  certificates         Certificate[]

  user    User?   @relation(fields: [loginId], references: [id])
  loginId String? @unique @db.ObjectId
  Like    Like[]
}

model MedicalRep {
  id                   String    @id @default(auto()) @map("_id") @db.ObjectId
  name                 String
  phone                String
  companyName          String
  companyLogoUrl       String?
  employeeId           String?
  departmentId         String?   @db.ObjectId
  about                String?
  subscriptionPlanId   String?   @db.ObjectId
  subscriptionStatus   Boolean?  @default(false)
  subscriptionStart    DateTime?
  subscriptionEnd      DateTime?
  maxConnectionsPerDay Int?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  department        Department?           @relation(fields: [departmentId], references: [id])
  subscriptionPlan  SubscriptionPlan?     @relation(fields: [subscriptionPlanId], references: [id])
  territories       MedicalRepTerritory[]
  products          ProductPost[]
  interests         Interest[]
  connections       Connection[]
  repConn1          RepConnection[]       @relation("Rep1")
  repConn2          RepConnection[]       @relation("Rep2")
  referralsGiven    RepReferral[]         @relation("ReferringRep")
  referralsReceived RepReferral[]         @relation("ReferredRep")
  conversations     Conversation[]

  doctorReferralsReceived DoctorReferral[] @relation("ReferredRep")

  educations   Education[]
  certificates Certificate[]

  user    User?   @relation(fields: [loginId], references: [id])
  loginId String? @unique @db.ObjectId
}

model SuperAdmin {
  id    String  @id @default(auto()) @map("_id") @db.ObjectId
  name  String
  phone String?

  user    User?   @relation(fields: [loginId], references: [id])
  loginId String? @unique @db.ObjectId
}

model Education {
  id           String      @id @default(auto()) @map("_id") @db.ObjectId
  degree       String
  institute    String
  year         Int?
  doctorId     String?     @db.ObjectId
  doctor       Doctor?     @relation(fields: [doctorId], references: [id])
  medicalRepId String?     @db.ObjectId
  medicalRep   MedicalRep? @relation(fields: [medicalRepId], references: [id])
}

model Certificate {
  id           String      @id @default(auto()) @map("_id") @db.ObjectId
  name         String
  issuedBy     String?
  year         Int?
  doctorId     String?     @db.ObjectId
  doctor       Doctor?     @relation(fields: [doctorId], references: [id])
  medicalRepId String?     @db.ObjectId
  medicalRep   MedicalRep? @relation(fields: [medicalRepId], references: [id])
}

model SubscriptionPlan {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  description String
  price       Float
  tenure      String
  features    String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  reps MedicalRep[]
}

model Territory {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  name      String
  region    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  doctors        Doctor[]
  products       ProductPost[]
  // requirements   DoctorRequirementPost[]
  repTerritories MedicalRepTerritory[]
}

model MedicalRepTerritory {
  id          String @id @default(auto()) @map("_id") @db.ObjectId
  repId       String @db.ObjectId
  territoryId String @db.ObjectId

  rep       MedicalRep @relation(fields: [repId], references: [id])
  territory Territory  @relation(fields: [territoryId], references: [id])
}

model ProductPost {
  id          String     @id @default(auto()) @map("_id") @db.ObjectId
  repId       String     @db.ObjectId
  title       String
  description String
  isArchived  Boolean    @default(false)
  imageUrl    String[]
  brand       String
  territoryId String?    @db.ObjectId
  useCases    String[]
  ingredients String[]
  termsOfUse  String
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  rep         MedicalRep @relation(fields: [repId], references: [id])
  territory   Territory? @relation(fields: [territoryId], references: [id])
  likes       Like[]
  interests   Interest[]
}

model Like {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  doctorId  String   @db.ObjectId
  productId String   @db.ObjectId
  createdAt DateTime @default(now())

  doctor  Doctor      @relation(fields: [doctorId], references: [id])
  product ProductPost @relation(fields: [productId], references: [id])

  @@unique([doctorId, productId])
  @@index([productId])
}

model Interest {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  doctorId  String   @db.ObjectId
  productId String   @db.ObjectId
  createdAt DateTime @default(now())

  doctor       Doctor      @relation(fields: [doctorId], references: [id])
  product      ProductPost @relation(fields: [productId], references: [id])
  medicalRep   MedicalRep? @relation(fields: [medicalRepId], references: [id])
  medicalRepId String?     @db.ObjectId

  @@unique([doctorId, productId])
  @@index([productId])
}

enum ConnectionStatus {
  PENDING
  ACCEPTED
  REJECTED
  CANCELLED
}

enum ConnectionInitiator {
  DOCTOR
  REP
}

model Connection {
  id        String              @id @default(auto()) @map("_id") @db.ObjectId
  doctorId  String              @db.ObjectId
  repId     String              @db.ObjectId
  status    ConnectionStatus    @default(PENDING)
  initiator ConnectionInitiator
  createdAt DateTime            @default(now())
  updatedAt DateTime            @updatedAt

  doctor Doctor     @relation(fields: [doctorId], references: [id])
  rep    MedicalRep @relation(fields: [repId], references: [id])

  @@unique([doctorId, repId], name: "doctorId_repId")
}

model DoctorConnection {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  doctorId1 String   @db.ObjectId
  doctorId2 String   @db.ObjectId
  status    String
  createdAt DateTime @default(now())

  doctor1 Doctor @relation("Doctor1", fields: [doctorId1], references: [id])
  doctor2 Doctor @relation("Doctor2", fields: [doctorId2], references: [id])
}

model RepConnection {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  repId1    String   @db.ObjectId
  repId2    String   @db.ObjectId
  status    String
  createdAt DateTime @default(now())

  rep1 MedicalRep @relation("Rep1", fields: [repId1], references: [id])
  rep2 MedicalRep @relation("Rep2", fields: [repId2], references: [id])
}

model DoctorReferral {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  referringDoctorId String   @db.ObjectId
  referredRepId     String   @db.ObjectId
  referredDoctorId  String   @db.ObjectId
  note              String
  status            String
  createdAt         DateTime @default(now())

  referringDoctor Doctor     @relation("ReferringDoctor", fields: [referringDoctorId], references: [id])
  referredRep     MedicalRep @relation("ReferredRep", fields: [referredRepId], references: [id])
  referredDoctor  Doctor     @relation("ReferredDoctor", fields: [referredDoctorId], references: [id])
}

model RepReferral {
  id               String   @id @default(auto()) @map("_id") @db.ObjectId
  referringRepId   String   @db.ObjectId
  referredDoctorId String   @db.ObjectId
  referredRepId    String   @db.ObjectId
  note             String
  status           String
  createdAt        DateTime @default(now())

  referringRep   MedicalRep @relation("ReferringRep", fields: [referringRepId], references: [id])
  referredDoctor Doctor     @relation("ReferredDoctorInRepReferral", fields: [referredDoctorId], references: [id])
  referredRep    MedicalRep @relation("ReferredRep", fields: [referredRepId], references: [id])
}

enum NotificationType {
  CONNECTION_REQUEST
  CONNECTION_ACCEPTED
  CONNECTION_REJECTED
  LIKE
  INTEREST
}

model Notification {
  id           String           @id @default(auto()) @map("_id") @db.ObjectId
  senderId     String           @db.ObjectId
  senderRole   Role
  receiverId   String           @db.ObjectId
  receiverRole Role
  type         NotificationType
  postId       String?
  content      String
  isRead       Boolean          @default(false)
  createdAt    DateTime         @default(now())

  sender   User @relation("SentNotifications", fields: [senderId], references: [id])
  receiver User @relation("ReceivedNotifications", fields: [receiverId], references: [id])
}

model Conversation {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  repId         String   @db.ObjectId
  doctorId      String   @db.ObjectId
  createdAt     DateTime @default(now())
  lastMessageAt DateTime

  rep      MedicalRep @relation(fields: [repId], references: [id])
  doctor   Doctor     @relation(fields: [doctorId], references: [id])
  messages Message[]
}
enum MessageType {
  TEXT
  IMAGE
  AUDIO
  VIDEO
  FILE
}

model Message {
  id             String   @id @default(auto()) @map("_id") @db.ObjectId
  conversationId String   @db.ObjectId
  senderId       String   @db.ObjectId
  senderRole     String
  content        String
  messageType    MessageType
  isRead         Boolean
  createdAt      DateTime @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id])
}
