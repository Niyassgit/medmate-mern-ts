generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model Department {
  id        String       @id @default(auto()) @map("_id") @db.ObjectId
  name      String
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  isActive  Boolean      @default(true)
  doctors   Doctor[]
  reps      MedicalRep[]
}

model otpVerification {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  otp       String
  purpose   String
  expiredAt DateTime
  createdAt DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiredAt], map: "otp_expiry_idx")
}

model User {
  id           String       @id @default(auto()) @map("_id") @db.ObjectId
  email        String       @unique
  password     String?
  role         Role
  profileImage String?
  tokenVersion Int          @default(0)
  authProvider AuthProvider @default(NATIVE)
  isBlocked    Boolean      @default(false)
  providerId   String?
  isVerified   Boolean      @default(false)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  senderNotifications   Notification[] @relation("SentNotifications")
  receiverNotifications Notification[] @relation("ReceivedNotifications")

  superAdmin       SuperAdmin?
  doctor           Doctor?
  medicalRep       MedicalRep?
  guest            Guest?
  otpVerifications otpVerification[]
}

enum Role {
  SUPER_ADMIN
  DOCTOR
  MEDICAL_REP
  GUEST
}

enum AuthProvider {
  NATIVE
  GOOGLE
}

model Doctor {
  id              String    @id @default(auto()) @map("_id") @db.ObjectId
  name            String
  phone           String
  departmentId    String?   @db.ObjectId
  experienceYears Int?
  hasOwnClinic    Boolean?
  doctorClass     String?
  territoryId     String?   @db.ObjectId
  hospital        String
  licenseImageUrl String?
  opStartTime     String?
  opEndTime       String?
  opSession       String?
  dob             DateTime?
  registrationId  String
  about           String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  department           Department?        @relation(fields: [departmentId], references: [id])
  territory            Territory?         @relation(fields: [territoryId], references: [id])
  interests            Interest[]
  connections          Connection[]
  doctorConn1          DoctorConnection[] @relation("Doctor1")
  doctorConn2          DoctorConnection[] @relation("Doctor2")
  referralsGiven       DoctorReferral[]   @relation("ReferringDoctor")
  referralsReceived    DoctorReferral[]   @relation("ReferredDoctor")
  conversations        Conversation[]
  repReferralsReceived RepReferral[]      @relation("ReferredDoctorInRepReferral")
  educations           Education[]
  certificates         Certificate[]

  user          User?          @relation(fields: [loginId], references: [id])
  loginId       String?        @unique @db.ObjectId
  Like          Like[]
  guests        Guest[]
  prescriptions Prescription[]
  commissions   Commission[]
}

model MedicalRep {
  id                   String    @id @default(auto()) @map("_id") @db.ObjectId
  name                 String
  phone                String
  companyName          String
  companyLogoUrl       String?
  employeeId           String?
  departmentId         String?   @db.ObjectId
  about                String?
  subscriptionPlanId   String?   @db.ObjectId
  subscriptionStatus   Boolean?  @default(false)
  subscriptionStart    DateTime?
  subscriptionEnd      DateTime?
  maxConnectionsPerDay Int?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  department        Department?           @relation(fields: [departmentId], references: [id])
  subscriptionPlan  SubscriptionPlan?     @relation(fields: [subscriptionPlanId], references: [id])
  territories       MedicalRepTerritory[]
  products          ProductPost[]
  interests         Interest[]
  connections       Connection[]
  repConn1          RepConnection[]       @relation("Rep1")
  repConn2          RepConnection[]       @relation("Rep2")
  referralsGiven    RepReferral[]         @relation("ReferringRep")
  referralsReceived RepReferral[]         @relation("ReferredRep")
  conversations     Conversation[]

  doctorReferralsReceived DoctorReferral[] @relation("ReferredRep")

  educations   Education[]
  certificates Certificate[]

  user                  User?                  @relation(fields: [loginId], references: [id])
  loginId               String?                @unique @db.ObjectId
  connectionRequestLogs ConnectionRequestLog[]
  subscriptionHistory   SubscriptionHistory[]
  catalogProducts       Product[]              @relation("RepCatalogProducts")
}

model SuperAdmin {
  id    String  @id @default(auto()) @map("_id") @db.ObjectId
  name  String
  phone String?

  user    User?   @relation(fields: [loginId], references: [id])
  loginId String? @unique @db.ObjectId
}

model Education {
  id           String      @id @default(auto()) @map("_id") @db.ObjectId
  degree       String
  institute    String
  year         Int?
  doctorId     String?     @db.ObjectId
  doctor       Doctor?     @relation(fields: [doctorId], references: [id])
  medicalRepId String?     @db.ObjectId
  medicalRep   MedicalRep? @relation(fields: [medicalRepId], references: [id])
}

model Certificate {
  id           String      @id @default(auto()) @map("_id") @db.ObjectId
  name         String
  issuedBy     String?
  year         Int?
  doctorId     String?     @db.ObjectId
  doctor       Doctor?     @relation(fields: [doctorId], references: [id])
  medicalRepId String?     @db.ObjectId
  medicalRep   MedicalRep? @relation(fields: [medicalRepId], references: [id])
}

model SubscriptionPlan {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  description String
  price       Float
  tenure      String
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  reps                MedicalRep[]
  subscriptionHistory SubscriptionHistory[]
  features            PlanFeature[]
}

model PlanFeature {
  id        String @id @default(auto()) @map("_id") @db.ObjectId
  planId    String @db.ObjectId
  featureId String @db.ObjectId

  plan    SubscriptionPlan @relation(fields: [planId], references: [id])
  feature Feature          @relation(fields: [featureId], references: [id])

  @@unique([planId, featureId])
}

model Feature {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  key         String   @unique
  description String
  createdAt   DateTime @default(now())

  plans PlanFeature[]
}

model Territory {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  name      String
  region    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  doctors        Doctor[]
  products       ProductPost[]
  // requirements   DoctorRequirementPost[]
  repTerritories MedicalRepTerritory[]
  guests         Guest[]
}

model MedicalRepTerritory {
  id          String @id @default(auto()) @map("_id") @db.ObjectId
  repId       String @db.ObjectId
  territoryId String @db.ObjectId

  rep       MedicalRep? @relation(fields: [repId], references: [id])
  territory Territory   @relation(fields: [territoryId], references: [id])
}

model ProductPost {
  id          String     @id @default(auto()) @map("_id") @db.ObjectId
  repId       String     @db.ObjectId
  title       String
  description String
  isArchived  Boolean    @default(false)
  imageUrl    String[]
  brand       String
  territoryId String?    @db.ObjectId
  useCases    String[]
  ingredients String[]
  termsOfUse  String
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  rep         MedicalRep @relation(fields: [repId], references: [id])
  territory   Territory? @relation(fields: [territoryId], references: [id])
  likes       Like[]
  interests   Interest[]
}

model Like {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  doctorId  String   @db.ObjectId
  productId String   @db.ObjectId
  createdAt DateTime @default(now())

  doctor  Doctor      @relation(fields: [doctorId], references: [id])
  product ProductPost @relation(fields: [productId], references: [id])

  @@unique([doctorId, productId])
  @@index([productId])
}

model Interest {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  doctorId  String   @db.ObjectId
  productId String   @db.ObjectId
  createdAt DateTime @default(now())

  doctor       Doctor      @relation(fields: [doctorId], references: [id])
  product      ProductPost @relation(fields: [productId], references: [id])
  medicalRep   MedicalRep? @relation(fields: [medicalRepId], references: [id])
  medicalRepId String?     @db.ObjectId

  @@unique([doctorId, productId])
  @@index([productId])
}

enum ConnectionStatus {
  PENDING
  ACCEPTED
  REJECTED
  CANCELLED
}

enum ConnectionInitiator {
  DOCTOR
  REP
}

model Connection {
  id        String              @id @default(auto()) @map("_id") @db.ObjectId
  doctorId  String              @db.ObjectId
  repId     String              @db.ObjectId
  status    ConnectionStatus    @default(PENDING)
  initiator ConnectionInitiator
  createdAt DateTime            @default(now())
  updatedAt DateTime            @updatedAt

  doctor Doctor     @relation(fields: [doctorId], references: [id])
  rep    MedicalRep @relation(fields: [repId], references: [id])

  @@unique([doctorId, repId], name: "doctorId_repId")
}

model DoctorConnection {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  doctorId1 String   @db.ObjectId
  doctorId2 String   @db.ObjectId
  status    String
  createdAt DateTime @default(now())

  doctor1 Doctor @relation("Doctor1", fields: [doctorId1], references: [id])
  doctor2 Doctor @relation("Doctor2", fields: [doctorId2], references: [id])
}

model RepConnection {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  repId1    String   @db.ObjectId
  repId2    String   @db.ObjectId
  status    String
  createdAt DateTime @default(now())

  rep1 MedicalRep @relation("Rep1", fields: [repId1], references: [id])
  rep2 MedicalRep @relation("Rep2", fields: [repId2], references: [id])
}

model DoctorReferral {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  referringDoctorId String   @db.ObjectId
  referredRepId     String   @db.ObjectId
  referredDoctorId  String   @db.ObjectId
  note              String
  status            String
  createdAt         DateTime @default(now())

  referringDoctor Doctor     @relation("ReferringDoctor", fields: [referringDoctorId], references: [id])
  referredRep     MedicalRep @relation("ReferredRep", fields: [referredRepId], references: [id])
  referredDoctor  Doctor     @relation("ReferredDoctor", fields: [referredDoctorId], references: [id])
}

model RepReferral {
  id               String   @id @default(auto()) @map("_id") @db.ObjectId
  referringRepId   String   @db.ObjectId
  referredDoctorId String   @db.ObjectId
  referredRepId    String   @db.ObjectId
  note             String
  status           String
  createdAt        DateTime @default(now())

  referringRep   MedicalRep @relation("ReferringRep", fields: [referringRepId], references: [id])
  referredDoctor Doctor     @relation("ReferredDoctorInRepReferral", fields: [referredDoctorId], references: [id])
  referredRep    MedicalRep @relation("ReferredRep", fields: [referredRepId], references: [id])
}

enum NotificationType {
  CONNECTION_REQUEST
  CONNECTION_ACCEPTED
  CONNECTION_REJECTED
  LIKE
  INTEREST
}

model Notification {
  id           String           @id @default(auto()) @map("_id") @db.ObjectId
  senderId     String           @db.ObjectId
  senderRole   Role
  receiverId   String           @db.ObjectId
  receiverRole Role
  type         NotificationType
  postId       String?
  content      String
  isRead       Boolean          @default(false)
  createdAt    DateTime         @default(now())

  sender   User @relation("SentNotifications", fields: [senderId], references: [id])
  receiver User @relation("ReceivedNotifications", fields: [receiverId], references: [id])
}

model Conversation {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  repId         String   @db.ObjectId
  doctorId      String   @db.ObjectId
  createdAt     DateTime @default(now())
  lastMessageAt DateTime @default(now())

  rep      MedicalRep @relation(fields: [repId], references: [id])
  doctor   Doctor     @relation(fields: [doctorId], references: [id])
  messages Message[]
}

enum MessageType {
  TEXT
  IMAGE
  AUDIO
  VIDEO
  FILE
}

model Message {
  id             String      @id @default(auto()) @map("_id") @db.ObjectId
  conversationId String      @db.ObjectId
  senderId       String      @db.ObjectId
  senderRole     Role
  content        String?
  messageType    MessageType
  isRead         Boolean     @default(false)
  createdAt      DateTime    @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id])
}

model ConnectionRequestLog {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  repId     String   @db.ObjectId
  date      DateTime @default(now())
  count     Int      @default(1)
  createdAt DateTime @default(now())

  rep MedicalRep @relation(fields: [repId], references: [id])

  @@unique([repId, date])
}

model SubscriptionHistory {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  repId           String   @db.ObjectId
  planId          String   @db.ObjectId
  sessionId       String
  paymentIntentId String?
  invoiceId       String?
  amount          Float
  currency        String
  status          String
  startDate       DateTime
  endDate         DateTime
  createdAt       DateTime @default(now())

  rep  MedicalRep       @relation(fields: [repId], references: [id])
  plan SubscriptionPlan @relation(fields: [planId], references: [id])

  @@index([repId])
  @@index([planId])
  @@index([status])
  @@index([createdAt])
}

model Guest {
  id           String  @id @default(auto()) @map("_id") @db.ObjectId
  loginId      String? @unique @db.ObjectId
  doctorId     String? @db.ObjectId
  territoryId  String? @db.ObjectId
  name         String
  phone        String?
  email        String?
  isRegistered Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user          User?          @relation(fields: [loginId], references: [id])
  doctor        Doctor?        @relation(fields: [doctorId], references: [id])
  territory     Territory?     @relation(fields: [territoryId], references: [id])
  prescriptions Prescription[]
  orders        Order[]
  addresses     Address[]

  @@unique([email, doctorId], name: "unique_guest_per_doctor")
  @@index([doctorId])
  @@index([email])
  @@index([isRegistered])
  @@index([territoryId])
}

model Address {
  id        String      @id @default(auto()) @map("_id") @db.ObjectId
  guestId   String      @db.ObjectId
  type      AddressType @default(HOME)
  fullName  String
  phone     String
  street    String
  city      String
  state     String
  zipCode   String
  country   String      @default("India")
  landmark  String?
  isDefault Boolean     @default(false)
  isActive  Boolean     @default(true)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  guest  Guest   @relation(fields: [guestId], references: [id])
  orders Order[]

  @@index([guestId])
  @@index([guestId, isDefault])
}

model Prescription {
  id            String             @id @default(auto()) @map("_id") @db.ObjectId
  doctorId      String             @db.ObjectId
  guestId       String             @db.ObjectId
  notes         String?
  status        PrescriptionStatus @default(PENDING)
  expiresAt     DateTime?
  shareToken    String?            @unique
  linkExpiresAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  doctor Doctor             @relation(fields: [doctorId], references: [id])
  guest  Guest              @relation(fields: [guestId], references: [id])
  items  PrescriptionItem[]
  order  Order?
}

model PrescriptionItem {
  id             String  @id @default(auto()) @map("_id") @db.ObjectId
  prescriptionId String  @db.ObjectId
  productId      String  @db.ObjectId
  dosage         String?
  quantity       Int     @default(1)

  prescription Prescription @relation(fields: [prescriptionId], references: [id])
  product      Product      @relation(fields: [productId], references: [id])
}

enum PrescriptionStatus {
  PENDING
  APPROVED
  REJECTED
  USED
  EXPIRED
}

enum AddressType {
  HOME
  WORK
  OTHER
}

model Order {
  id              String        @id @default(auto()) @map("_id") @db.ObjectId
  guestId         String        @db.ObjectId
  prescriptionId  String        @unique @db.ObjectId
  addressId       String        @db.ObjectId
  totalAmount     Float
  status          OrderStatus   @default(PENDING)
  paymentStatus   PaymentStatus @default(PENDING)
  deliveryAddress String
  paymentId       String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  guest        Guest        @relation(fields: [guestId], references: [id])
  prescription Prescription @relation(fields: [prescriptionId], references: [id])
  address      Address      @relation(fields: [addressId], references: [id])
  commission   Commission[]
}

enum OrderStatus {
  PENDING
  CONFIRMED
  SHIPPED
  DELIVERED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
  REFUNDED
}

model Commission {
  id        String @id @default(auto()) @map("_id") @db.ObjectId
  orderId   String @db.ObjectId
  productId String @db.ObjectId
  doctorId  String @db.ObjectId

  mrp       Float
  ptr       Float
  adminCut  Float
  doctorCut Float

  status    CommissionStatus @default(PENDING)
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  order   Order   @relation(fields: [orderId], references: [id])
  doctor  Doctor  @relation(fields: [doctorId], references: [id])
  product Product @relation(fields: [productId], references: [id])
}

enum CommissionStatus {
  PENDING
  SETTLED
}

model Product {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  repId        String   @db.ObjectId
  name         String
  brand        String
  imageUrl     String[]
  ingredients  String[]
  // useCases     String[]
  mrp          Float
  ptr          Float
  territoryIds String[] @db.ObjectId

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  rep               MedicalRep         @relation("RepCatalogProducts", fields: [repId], references: [id])
  commission        Commission[]
  prescriptionItems PrescriptionItem[]
}
